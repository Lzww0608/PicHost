# 8. 日志记录

项目使用了 **spdlog 日志库** 来记录日志。 日志记录贯穿于整个后端服务程序 tc-src/tc_http_server 中，用于记录程序运行状态、错误信息、请求处理信息等，方便开发调试、问题排查和系统监控。

**1. 日志库：spdlog**

- **明确使用 spdlog:** 在提供的代码文件 dlog.cc 和 dlog.h 中，可以清晰地看到项目 **封装了 spdlog 日志库**。 DLog 类是对 spdlog::logger 的一个简单封装。
- **现代 C++ 日志库:** spdlog 是一个 **开源、高性能、header-only 的 C++ 日志库**，被广泛应用于各种 C++ 项目中。 选择 spdlog 表明项目对 **日志性能和易用性** 有一定的要求。

**2. 日志记录机制:**

- **全局日志对象:** 项目通过 DLog::GetInstance() 获取 **单例的 DLog 对象**，并使用 DLog::getLogger() 获取 spdlog::logger 实例。 这使得在代码的任何地方都可以方便地使用全局日志对象进行日志记录。
- **宏定义简化日志调用:** 项目定义了一系列 **宏 (macros)** 来简化日志记录的调用 (参考 dlog.h):
  - LogError(...): 记录 **Error 级别** 的日志。
  - LogWarn(...): 记录 **Warning 级别** 的日志。
  - LogInfo(...): 记录 **Info 级别** 的日志。
  - LogDebug(...): 记录 **Debug 级别** 的日志。
  - LogTrace(...): 记录 **Trace 级别** 的日志 (最详细的级别，通常用于开发调试)。
  - 这些宏内部会调用 spdlog::logger 实例的对应级别的日志记录函数 (例如 log_->error, log_->warn, log_->info 等)。
- **格式化输出:** 日志宏支持 **格式化输出**，可以使用类似于 printf 的格式化字符串，方便地将变量值、程序状态等信息插入到日志消息中 (例如 LogError("decodeRegisterJson failed") 或 LogInfo("执行: {}", sql_cmd)).
- **文件日志输出:** 日志信息最终会输出到 **日志文件** 中，文件名很可能是 trackerd.log, storaged.log, tc_http_server.log 等 (根据组件不同而不同)。 日志文件通常会按照 **日期或大小进行轮转 (log rotation)**， 以避免日志文件过大。 具体的日志文件路径和轮转策略可能在配置文件中进行配置 (虽然文档中没有明确指出如何配置日志路径和轮转，但通常日志库都会提供配置选项)。

**3. 日志级别划分:**

项目使用了 spdlog 提供的 **标准日志级别** (参考 dlog.cc 中 DLog::SetLevel 函数):

- **Trace:** 最详细的日志级别，记录程序运行的 **最细粒度信息**，通常用于 **开发调试阶段**，跟踪代码执行流程和变量值。 在生产环境中通常禁用，因为会产生大量的日志，影响性能。
- **Debug:** 记录 **调试信息**，比 Trace 级别更粗粒度，用于 **开发和测试阶段**，帮助开发者理解程序运行状态和排查问题。 在生产环境中通常也禁用或谨慎使用。
- **Info:** 记录程序运行的 **一般信息**，例如 **启动信息、关键业务流程的开始和结束、重要状态变更** 等。 在生产环境中通常启用，用于 **监控系统运行状态和业务流程**。
- **Warning:** 记录 **警告信息**，表示程序运行中 **可能存在潜在问题或异常情况**，但不影响程序正常运行。 例如，配置项缺失、使用了默认值、网络连接不稳定等。 在生产环境中应该关注 Warning 日志，及时处理潜在问题。
- **Error:** 记录 **错误信息**，表示程序运行中 **发生了错误**，可能会影响部分功能或业务流程。 例如，数据库连接失败、文件读写错误、参数校验失败等。 在生产环境中必须高度关注 Error 日志，及时排查和解决错误。
- **Critical:** 记录 **严重错误信息**，表示程序运行中 **发生了致命错误**， **可能导致系统崩溃或数据丢失** 等严重后果。 例如，内存溢出、核心组件崩溃、严重配置错误等。 在生产环境中必须立即处理 Critical 日志，确保系统尽快恢复正常运行。
- **Off:** **禁用所有日志记录**。 在生产环境中，可以根据需要动态调整日志级别，例如在排查问题时临时开启 Debug 或 Trace 级别，平时保持 Info 或 Warn 级别。

**4. 日志级别配置:**

- **配置文件 (tc_http_server.conf):** 在 tc_http_server.conf 配置文件中，有以下相关配置项:

  ```
  # trace debug info warn err critical off
  # 测试性能的时候改为warn级别
  log_level=info
  ```

  

  log_level 配置项用于 **设置日志级别**，可选值包括 trace, debug, info, warn, err, critical, off。 默认值为 info。 在 "测试性能的时候改为warn级别" 的注释暗示了 **可以根据不同的环境和需求动态调整日志级别**，例如在 **性能测试** 时，可以将日志级别设置为 warn 或更高，以减少日志输出，降低性能影响；在 **开发调试** 时，可以将日志级别设置为 debug 或 trace，以便获取更详细的日志信息。

- **动态调整日志级别:** 通过修改配置文件并重启服务，可以 **动态调整日志级别**。 更高级的日志系统可能还支持 **运行时动态调整日志级别**，无需重启服务。

**总结:**

项目使用了 **spdlog 日志库** 进行日志记录，通过 **宏定义** 简化了日志调用，并支持 **多种日志级别** (Trace, Debug, Info, Warn, Error, Critical)。 日志级别可以通过 **配置文件 tc_http_server.conf** 进行配置。 完善的日志系统对于项目的开发、调试、维护和监控都至关重要。 通过合理的日志级别划分和配置，可以有效地平衡日志的 **详细程度** 和 **性能开销**，满足不同场景下的日志需求。