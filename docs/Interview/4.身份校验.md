# 在处理用户请求时，你们是如何进行用户身份验证和权限控制的?

**1. 用户身份验证 (Authentication):**

- **登录接口 (/api/login)**: 用户首先需要通过登录接口提供用户名 (userName) 和密码 (pwd) 进行身份验证。
- **密码验证:** 后端服务器 (api_login.cc -> handleLoginRequest) 接收到登录请求后，会执行以下步骤：
  - **提取用户名和密码:** 从请求参数中获取用户名和密码。
  - **查询数据库 (user_info 表):** 根据用户名查询 user_info 表，获取数据库中存储的 **加密后的密码**。
  - **密码比对:** 将用户提供的密码 (经过 MD5 加密后) 与数据库中存储的加密密码进行比对。
  - **验证结果:**
    - **验证成功:** 如果密码匹配，则验证成功，用户身份合法。
    - **验证失败:** 如果密码不匹配或用户不存在，则验证失败。
- **Token 生成 (成功登录后):** 如果用户身份验证成功，后端服务器会生成一个 **唯一的 Token** (令牌) :
  - **Token 生成算法:** Token 是 "随机数+base64+md5 生成的 token"。
  - **Token 存储 (Redis):** 生成的 Token 会被 **存储到 Redis 缓存中**。 Redis 的 Key 可以是 Token 值本身，Value 可以存储与 Token 关联的用户信息 (例如用户名)。 文档中提到 "token用来后续请求做匹配校验（服务器的token存储在redis）"。
- **Token 返回客户端:** 后端服务器将生成的 Token 通过 JSON 响应返回给客户端 (例如 encodeLoginJson，响应体包含 "code": 0, "token": "<生成的token值>").

**2. 权限控制 (Authorization):**

- **Token 携带:** 客户端在后续请求需要 **身份验证的 API 接口** 时 (例如上传文件、获取个人文件列表、分享文件等)， **必须在请求中携带 Token**。 Token 通常会放在 HTTP 请求头 (Header) 或请求体 (Body) 中，本项目文档示例中，Token 作为请求参数传递 (例如在 api_myfiles.cc 的请求参数中包含 token 参数)。
- **Token 验证 (API 接口入口处):** 后端服务器接收到需要身份验证的 API 请求后，会在 API 接口的处理函数入口处 **进行 Token 验证** (参考文档 "2.1.2 处理逻辑" 和 各个 API 的 "处理逻辑" 部分):
  - **提取 Token:** 从请求中提取客户端提交的 Token 值 (例如从请求参数中获取 token 值)。
  - **Redis 查询:** 使用提取的 Token 值作为 Key，查询 Redis 缓存， **检查是否存在对应的 Token 记录**。
  - **Token 有效性判断:**
    - **Token 存在 (Redis 中找到记录):** 说明 Token 有效，用户身份已验证。 可以继续执行后续的业务逻辑。
    - **Token 不存在 (Redis 中未找到记录):** 说明 Token 无效或已过期，用户身份未验证或验证失败。 服务器会拒绝请求，返回 **身份验证失败** 的错误响应 (例如 encodeDealfileJson 中提到 "token 验证失败: {code: 4}")。
- **API 接口级别的权限控制:** Token 验证通过后，表示用户身份合法。 **本项目的权限控制主要体现在 API 接口级别**，即只要 Token 验证通过，用户就可以访问对应的 API 接口，执行该接口定义的操作 (例如上传文件到 /api/upload，获取个人文件列表 /api/myfiles 等)。 **更细粒度的权限控制 (例如基于角色的权限控制) 在本项目中没有体现。**

**总结流程:**

1. **用户登录 (/api/login):** 用户提供用户名密码，服务器验证成功后生成 Token 并返回。
2. **Token 存储 (客户端):** 客户端需要妥善保存 Token (例如 Local Storage 或 Cookie)。
3. **API 请求 (需要身份验证的接口):** 客户端在请求需要身份验证的 API 接口时，必须携带 Token。
4. **Token 验证 (服务端):** 服务端在 API 接口入口处验证 Token 的有效性 (通过查询 Redis)。
5. **权限控制 (API 接口级别):** Token 验证通过后，用户被授权访问该 API 接口，执行相应的操作。

**关键点:**

- **Token 作为身份凭证:** Token 是用户身份的唯一凭证，客户端需要在后续请求中携带 Token 以证明身份。
- **Redis 存储 Token:** Redis 用于高效地存储和验证 Token，提高系统性能。
- **API 接口级别权限控制:** 基于 Token 的身份验证实现了 API 接口级别的权限控制。
- **无状态验证:** Token 验证是无状态的，服务端不需要存储用户的登录状态，只需验证 Token 的有效性即可，方便水平扩展。