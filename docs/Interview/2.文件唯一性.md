# 在图片上传的处理流程中，你们是如何保证上传文件的唯一性的？

**核心机制：MD5 校验与预先检查**

1. **客户端计算 MD5 （未实现）:**
   - 在客户端（例如 Web 浏览器），可以在文件上传之前计算待上传文件的 MD5 哈希值。虽然文档中没有明确要求客户端计算 MD5，但在实际应用中，客户端计算 MD5 可以**提前**进行文件唯一性判断，减少不必要的网络传输。
   - 如果客户端计算了 MD5，可以将 MD5 值作为参数随上传请求一起发送到服务器。
2. **服务器端 MD5 校验 (关键步骤):**
   - **api_md5.cc 接口：** 客户端在正式上传文件之前，**应该先调用 /api/md5 接口**，并提供以下信息：
     - filename: 文件名 (用于记录，非唯一性判断关键)
     - md5: 待上传文件的 MD5 哈希值 (**关键参数**)
     - token: 用户身份验证 Token
     - user: 用户名
   - **服务器端处理 (api_md5.cc 逻辑):**
     - **Token 验证:** 首先验证 token 的有效性，确保是合法用户操作。
     - **Reids查询 file_info 表:** 根据客户端提供的 md5 值，查询 file_info 数据表中是否已经存在相同的 md5 记录。
     - **判断文件是否已存在：**
       - **如果数据库中已存在相同的 md5 记录：** 说明服务器上已经存在相同文件内容的文件。此时，服务器 **不会** 真正接收客户端上传的文件内容，而是直接返回**秒传成功**的响应 (例如 code: 0)。
       - **如果数据库中不存在相同的 md5 记录：** 说明这是一个新的文件。服务器返回 **文件不存在** 的响应 (例如，可以理解为 code 不是 0，或者特定的 code 表示文件不存在)。
3. **api_upload.cc 接口：正式上传文件 (仅当文件不存在时):**
   - 只有在 /api/md5 接口返回文件不存在的情况下，客户端才需要真正调用 /api/upload 接口上传文件内容。
   - **服务器端处理 (api_upload.cc 逻辑):**
     - **接收文件:** 通过 nginx-upload-module 接收客户端上传的文件内容。
     - **再次计算 MD5 (双重校验):** 为了安全和数据完整性，服务器端在接收到文件后，**会再次计算** 接收到的文件的 MD5 哈希值，并与客户端在 /api/md5 接口中提供的 MD5 值进行 **二次校验**，确保文件在传输过程中没有损坏或被篡改。
     - **存储文件到 FastDFS:** 将文件存储到 FastDFS 分布式文件系统。
     - **记录文件元数据到 MySQL:** 将文件的相关元数据信息（包括文件名、MD5 值、FastDFS 文件 ID、上传时间等）**写入 file_info 数据表**。
     - **更新用户文件列表:** 在 user_file_list 表中记录该用户上传了该文件。
     - **更新用户文件计数:** 增加 user_file_count 表中该用户的文件计数。
     - **返回上传成功响应:** 返回上传成功的响应 (例如 code: 0)。

**总结流程**

1. **预先 MD5 检查 (/api/md5):** 客户端先发送文件 MD5 到服务器查询是否已存在相同文件。
2. **秒传 (如果 MD5 已存在):** 如果服务器发现 MD5 已存在，则直接返回秒传成功，**无需上传文件内容**。
3. **正式上传 (/api/upload):** 如果服务器 /api/md5 接口返回文件不存在，客户端才真正上传文件内容到 /api/upload 接口。
4. **服务器存储和记录:** 服务器接收文件，二次校验 MD5，存储文件到 FastDFS，并将文件元数据记录到 MySQL 数据库。

**保证唯一性的关键点**

- **MD5 哈希值作为唯一标识:** 项目使用文件的 MD5 哈希值作为文件内容唯一性的标识符。MD5 具有很高的概率保证不同内容的文件拥有不同的 MD5 值。
- **file_info 表的 md5 字段:** file_info 表的 md5 字段是核心，通过在 file_info 表中查找 md5 值来判断文件是否已存在。
- **先检查后上传:** 先通过 /api/md5 接口进行预先检查，避免重复上传相同文件内容。
- **服务器端二次校验:** 在正式上传过程中，服务器端再次计算 MD5 并校验，确保数据完整性和安全性。