# 15.Storage Server存储机制

**1. Group (组/卷/Volume):**

- **最高级别的组织单位:** 在 FastDFS 中，**Group 是 Storage Server 组织和管理存储空间的 最高级别单位**。 你可以将 Group 理解为一个 **独立的存储集群** 或 **逻辑卷** (Volume，Volume 实际上就是 Group 的别名，文档中 "Storage server（后简称storage）以组（卷，group或volume）为单位组织" 也说明了这一点)。
- **数据冗余和备份:** 一个 Group 内包含 **多台 Storage Server (Storage 节点)**。 **Group 内的 Storage Server 之间互为 副本 (replica)**， 存储相同的数据，实现 **数据冗余和备份**。 文档中 "一个group内包含多台 storage机器，数据互为备份" 强调了这一点。 这意味着，即使 Group 内的 **部分 Storage Server 发生故障，数据仍然是安全的，系统可以继续提供服务**。
- **存储容量和扩展:** **Group 的总存储容量 受限于 Group 内容量最小的 Storage Server 的容量**。 文档中 "存储空间以group内容量最小的storage为准" 说明了这一点。 因此，为了充分利用存储空间，建议 Group 内的 Storage Server **尽量配置相同的存储容量**。 **Group 的横向扩展可以通过 增加 Group 内的 Storage Server 数量 来实现， 从而增加 Group 的总吞吐量和可用性**。
- **应用隔离和负载均衡:** **FastDFS 以 Group 为单位进行应用隔离、负载均衡和副本数定制**。 文档中 "以group为单位组织存储能方便的进行应用隔离、负载均衡、副本数定制" 强调了这一点。 可以将 **不同应用的数据存储到不同的 Group 中，实现 应用数据隔离**。 也可以根据应用的访问特性，将应用 **分配到不同的 Group 来做 负载均衡**。 **Group 内 Storage Server 的数量 (即副本数) 可以根据应用的可靠性需求进行定制**。

**2. Storage Path (存储目录):**

- **Storage Server 本地存储目录:** 每个 Storage Server **可以配置 多个 本地文件系统目录作为 数据存储目录 (storage path)**。 文档中 "storage可配置多个数据存储目录，比如有10块磁盘，分别挂载在/data/disk1-/data/disk10，则可将这10个目录都配置为storage的数据存储目录" 给出了示例。 **存储目录用于 实际存储文件数据**。
- **扩展存储空间:** 配置多个存储目录可以 **扩展单个 Storage Server 的存储空间**， 充分利用服务器的磁盘资源。 例如，如果服务器有多个磁盘，可以将每个磁盘挂载到一个存储目录下，并将这些目录都配置为 Storage Server 的存储目录。
- **负载均衡 (磁盘级别):** Storage Server **在存储文件时，会在 配置的多个存储目录之间进行负载均衡**。 文档中 "storage接受到写文件请求时，会根据配置好的规则，选择其中一个存储目录来存储文件" 说明了这一点。 默认的负载均衡策略是 **轮询 (Round Robin)**， 即 **轮流选择存储目录来存储新文件**， 使得 **文件均匀分布在不同的存储目录 (磁盘) 上**， **平衡磁盘 I/O 负载**。

**3. Two-Level Subdirectories (两级子目录):**

- **目的: 避免单目录文件数量过多，提高文件访问性能。** 文档中 "为了避免单个目录下的文件数太多，在storage第一次启动时，会在每个数据存储目录里创建2级子目录，每级256个，总共 65536个文件" 明确说明了这一点。
- **两级 Hash 子目录结构:** Storage Server **在每个数据存储目录下 预先创建两级子目录结构**， **每级子目录都有 256 个子目录**， 总共 256 * 256 = 65536 个子目录。 子目录名使用 **十六进制数字** 表示 (例如 00, 01, ..., ff)。
- **Hash 路由:** 当有新文件需要存储时，Storage Server **根据文件的 FileID *进行两次 Hash 计算 (猜测)* **， **将 Hash 结果 映射到 其中一个 二级子目录**。 文档中 "新写的文件会以hash的方式被路由到其中某个子目录下" 说明了这一点。 具体 Hash 算法文档中没有明确说明，但推测可能是 **基于 FileID 的某些部分进行 Hash 计算**， 例如 FileID 的一部分字符或数字。
- **文件分散存储:** 通过两级子目录和 Hash 路由，Storage Server **将 大量文件 分散 存储到 不同的子目录 中**， ***避免了单个目录下文件数量过多***， 从而 **提高了文件系统的 查找效率 和 I/O 性能**。 试想一下， 如果所有文件都存储在同一个目录下，当文件数量达到百万甚至千万级别时，文件系统的性能会急剧下降， 查找文件会变得非常缓慢。 而使用两级子目录结构，可以将文件 **分散到 65536 个子目录中**， 每个子目录下的文件数量大大减少， 文件查找效率显著提升。

**4. Filename Generation Rules (文件名生成规则):**

- **FileID 作为文件名:** **最终存储在子目录下的 文件名 就是 文件的 FileID (文件 ID)**。 文档中 "然后将文件以fileid为文件名存储到该子目录下" 明确说明了这一点。
- **FileID 组成:** FileID **是一个 字符串 ， 由多个字段拼接而成，并进行 Base64 编码**。 文档 "文件名 group1/M00/00/00/eBuDxWCfCEAEFUrAAAAKTIQHvk462.txt" 部分给出了 FileID 的示例和组成字段：
  - group1: **Group 名称**。
  - M00/00/00: **存储目录和两级子目录路径** (例如 M00 表示存储目录， 00/00 表示两级子目录)。 实际的子目录名会根据 Hash 结果动态生成。
  - eBuDxWCfCEAEFUrAAAAKTIQHvk462: **Base64 编码后的 二进制串**， 二进制串包含以下字段 (文档 "eBuDxWCb2qmAQ89yAAAAKeR1iIo162" 部分):
    - storage_id (ip 的数值型): **Storage Server 的 ID 或 IP 地址** (数值型)。
    - timestamp: **文件创建时间戳** (Unix 时间戳)。
    - file_size: **文件大小** (字节数)。
    - crc32: **文件内容的 CRC32 校验码**。
    - random number: **随机数** (用于防止生成重复的文件名)。
  - .txt: **文件后缀名** (由客户端指定，主要用于区分文件类型)。
- **文件名唯一性:** FileID **保证了文件名的 全局唯一性**， 即使在整个 FastDFS 集群中，也不会出现重复的文件名。 唯一性主要由 **Storage Server ID、时间戳、随机数** 等字段来保证。

**总结：**

Storage Server **以 Group 为单位组织存储空间**， Group 内包含多台 Storage Server **实现数据冗余**。 每个 Storage Server **使用多个存储目录扩展存储空间**， 并在每个存储目录下创建 **两级 Hash 子目录结构 分散存储文件**。 **文件名 (FileID) 全局唯一**， 由多个字段组成并进行 Base64 编码。 这种存储机制 **兼顾了 数据冗余、存储扩展性、性能和文件管理效率**， 是 FastDFS **高效、可靠地存储海量小文件** 的关键所在。