# 用户分享图片时，系统是如何生成分享链接的？这个链接的结构是怎样的？

**分享链接生成流程 :**

1. **用户发起分享请求:** 当用户在客户端点击 "分享" 按钮，并选择要分享的图片时，客户端会构建一个 HTTP POST 请求发送到后端服务器的 /api/sharepic?cmd=share 接口。
2. **请求参数:** 这个分享请求会携带以下关键参数 :
   - token: 用户的身份验证令牌，用于验证用户身份。
   - user: 用户名，标识分享用户。
   - md5: 要分享的图片文件的 MD5 哈希值，用于在数据库中唯一标识该文件。
   - filename: 图片文件名 (非关键参数，主要是为了记录和方便管理)。
3. **后端处理 ( api_sharepicture.cc -> handleSharePicture):**
   - **身份验证:** 后端服务器首先会验证 token 的有效性，确认请求来自合法用户。
   - **创建分享记录:** handleSharePicture 函数会在 share_picture_list 表中创建一个新的记录，用于存储本次图片分享的信息。 关键字段包括:
     - user: 分享用户的用户名。
     - filemd5: 分享的图片文件的 MD5 值。
     - file_name: 分享的图片文件名。
     - create_time: 分享创建时间。
     - **urlmd5 (关键字段):** **系统会生成一个唯一的 urlmd5 值，作为本次分享的唯一标识符。**
   - **缓存分享信息到 Redis (可选):** 为了提高浏览分享链接时的访问速度，系统可能会将分享的图片信息 (包括 urlmd5 和图片元数据) 缓存到 Redis 中，键值对的 Key 可以是 urlmd5。
   - **生成分享链接:** 系统根据配置生成最终的分享链接，这个链接的关键部分就是包含生成的 urlmd5 值。
4. **返回分享链接 ( encodeSharePictureJson):** 后端服务器将处理结果封装成 JSON 响应返回给客户端，响应中包含：
   - code: 0 (表示成功)。
   - **urlmd5 (关键返回值):** **将生成的 urlmd5 值返回给客户端。**

**分享链接的结构:**

- **用户可访问的 "访问链接" (Access Link):**

  ```
  http://<域名或IP>/api/share?urlmd5=<urlmd5值>
  ```

  - **http://<域名或IP>:** 这是图床系统的访问域名或 IP 地址 (例如 http://192.168.1.27 或 http://39.101.196.39)。
  - **/api/share:** 这是前端 Web 页面路由解析的路径，用于指示访问的是分享链接。
  - **?urlmd5=<urlmd5值>:** 这是一个 URL 查询参数，参数名为 urlmd5，参数值就是后端生成的 **唯一 urlmd5 标识符**。 例如：?urlmd5=602fdf30db2aacf517badf4565121234

  **这个 "访问链接" 是用户最终分享给别人的链接，用户可以直接复制这个链接在浏览器中打开，即可浏览分享的图片。** Web 服务器 (Nginx) 会拦截 /api/share 路径的请求，并将其转发到前端 Web 页面进行处理 (例如，通过 JavaScript 解析 urlmd5 参数，再调用后端的 "请求接口链接" 获取图片信息并展示)。

- **后端 API "请求接口链接" (Request API Link):**

  ```
  http://<域名或IP>/api/sharepic?cmd=browse
  ```

  - **http://<域名或IP>:** 同样是图床系统的域名或 IP 地址。
  - **/api/sharepic:** 这是后端 API 的接口路径。
  - **?cmd=browse:** URL 查询参数，指示要执行的操作是 "浏览分享图片"。

  **这个 "请求接口链接" 不是直接分享给用户的链接，而是前端 Web 页面内部用于向后端 API 发送请求，获取图片详细信息的接口。** 前端 Web 页面会解析 "访问链接" 中的 urlmd5 参数，然后将 urlmd5 值作为请求体 (POST) 发送到 "请求接口链接" (/api/sharepic?cmd=browse)，后端 API 根据 urlmd5 查找图片信息并返回给前端，前端再将图片展示给用户。

**总结:**

当用户分享图片时，系统会生成一个唯一的 urlmd5 值，并将其包含在 "访问链接" 中返回给用户。 "访问链接" 是最终分享给别人的链接，用户可以通过这个链接访问到分享的图片。 "请求接口链接" 是后端 API 接口，前端 Web 页面通过这个接口根据 urlmd5 获取图片详细信息。 urlmd5 是连接 "访问链接" 和后端图片数据的桥梁，确保了分享链接的简洁性和安全性。